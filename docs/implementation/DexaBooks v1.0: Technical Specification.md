# DexaBooks v1.0: Technical Specification

**Date:** October 29, 2025  
**Author:** Manus AI  
**Status:** Ready for Implementation

---

## 1. Database Schema Extensions

DexaBooks extends the LoomLite Ontology Standard v2.2 by introducing three new tables. These tables inherit the vector and provenance patterns established by the existing system, ensuring full interoperability with the existing semantic search and audit trail infrastructure.

### 1.1 `transactions` Table

This table stores individual financial transactions parsed from uploaded CSV files or QuickBooks exports.

| Field | Type | Description | Nullable |
|---|---|---|---|
| `id` | TEXT | UUID primary key | No |
| `account_id` | TEXT | Foreign key to `accounts` table | Yes |
| `date` | TEXT | ISO 8601 date of the transaction | No |
| `amount` | REAL | Transaction amount (negative for expenses, positive for income) | No |
| `vendor` | TEXT | Merchant or payee name | Yes |
| `category` | TEXT | Expense category (e.g., "Utilities", "Payroll") | Yes |
| `description` | TEXT | Full transaction description or memo | Yes |
| `recurrence` | TEXT | Detected pattern: `null`, `weekly`, `monthly`, `quarterly`, `yearly` | Yes |
| `predicted` | INTEGER | Boolean flag: 0 = actual, 1 = forecasted | No |
| `created_at` | TEXT | ISO 8601 timestamp of record creation | No |
| `vector` | BLOB | Compressed 384-dimensional semantic vector | Yes |
| `vector_fingerprint` | TEXT | Provenance fingerprint (`{model}:{dim}:{hash}:{timestamp}`) | Yes |
| `vector_model` | TEXT | Embedding model used (default: `all-MiniLM-L6-v2`) | Yes |
| `vector_dimension` | INTEGER | Vector dimensionality (default: 384) | Yes |

**Indexes:**
- `idx_transactions_date` on `date` for fast time-range queries
- `idx_transactions_account_id` on `account_id` for filtering by account

### 1.2 `forecasts` Table

This table stores predicted future transactions generated by the recurrence detection algorithm.

| Field | Type | Description | Nullable |
|---|---|---|---|
| `id` | TEXT | UUID primary key | No |
| `source_transaction_id` | TEXT | Foreign key to the `transactions` table (the historical transaction this forecast is based on) | No |
| `expected_date` | TEXT | ISO 8601 date when the expense is predicted to occur | No |
| `predicted_amount` | REAL | Forecasted amount | No |
| `confidence` | REAL | Confidence score (0.0 to 1.0) based on historical consistency | No |
| `status` | TEXT | `pending`, `confirmed`, `missed` (for tracking accuracy over time) | No |
| `created_at` | TEXT | ISO 8601 timestamp of forecast generation | No |

**Indexes:**
- `idx_forecasts_expected_date` on `expected_date` for timeline queries
- `idx_forecasts_source_transaction_id` on `source_transaction_id` for linking back to historical data

### 1.3 `accounts` Table

This table stores financial account metadata, allowing users to organize transactions by bank account, credit card, or cash.

| Field | Type | Description | Nullable |
|---|---|---|---|
| `id` | TEXT | UUID primary key | No |
| `account_name` | TEXT | User-defined account name (e.g., "Chase Checking", "Amex Business") | No |
| `account_type` | TEXT | `checking`, `savings`, `credit`, `cash` | No |
| `balance` | REAL | Current account balance (updated manually or via sync) | Yes |
| `last_update` | TEXT | ISO 8601 timestamp of last balance update | Yes |
| `created_at` | TEXT | ISO 8601 timestamp of account creation | No |

### 1.4 Migration Script

A new migration script will be created at `loomlite/backend/migrate_dexabooks.py` to add these tables to the existing database without disrupting LoomLite's data.

```python
import sqlite3
import os

DB_PATH = os.path.join(os.path.dirname(__file__), "loom_lite_v2.db")

def migrate():
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    
    # Create transactions table
    cur.execute("""
        CREATE TABLE IF NOT EXISTS transactions (
            id TEXT PRIMARY KEY,
            account_id TEXT,
            date TEXT NOT NULL,
            amount REAL NOT NULL,
            vendor TEXT,
            category TEXT,
            description TEXT,
            recurrence TEXT,
            predicted INTEGER NOT NULL DEFAULT 0,
            created_at TEXT NOT NULL,
            vector BLOB,
            vector_fingerprint TEXT,
            vector_model TEXT,
            vector_dimension INTEGER,
            FOREIGN KEY (account_id) REFERENCES accounts(id)
        )
    """)
    
    # Create forecasts table
    cur.execute("""
        CREATE TABLE IF NOT EXISTS forecasts (
            id TEXT PRIMARY KEY,
            source_transaction_id TEXT NOT NULL,
            expected_date TEXT NOT NULL,
            predicted_amount REAL NOT NULL,
            confidence REAL NOT NULL,
            status TEXT NOT NULL DEFAULT 'pending',
            created_at TEXT NOT NULL,
            FOREIGN KEY (source_transaction_id) REFERENCES transactions(id)
        )
    """)
    
    # Create accounts table
    cur.execute("""
        CREATE TABLE IF NOT EXISTS accounts (
            id TEXT PRIMARY KEY,
            account_name TEXT NOT NULL,
            account_type TEXT NOT NULL,
            balance REAL,
            last_update TEXT,
            created_at TEXT NOT NULL
        )
    """)
    
    # Create indexes
    cur.execute("CREATE INDEX IF NOT EXISTS idx_transactions_date ON transactions(date)")
    cur.execute("CREATE INDEX IF NOT EXISTS idx_transactions_account_id ON transactions(account_id)")
    cur.execute("CREATE INDEX IF NOT EXISTS idx_forecasts_expected_date ON forecasts(expected_date)")
    cur.execute("CREATE INDEX IF NOT EXISTS idx_forecasts_source_transaction_id ON forecasts(source_transaction_id)")
    
    conn.commit()
    conn.close()
    print("âœ… DexaBooks schema migration complete")

if __name__ == "__main__":
    migrate()
```

---

## 2. Backend API Specification

All DexaBooks endpoints will be prefixed with `/api/dexabooks/` to maintain clear separation from LoomLite's ontology endpoints.

### 2.1 `POST /api/dexabooks/ingest`

**Purpose:** Upload and process a CSV file of financial transactions.

**Request:**
- `Content-Type: multipart/form-data`
- `file`: The CSV file to upload

**CSV Format Expected:**
```csv
date,amount,vendor,category,description
2025-10-15,-1200.00,Landlord Inc,Rent,Monthly office rent
2025-10-20,-85.43,Electric Co,Utilities,October electricity
```

**Response:**
```json
{
  "job_id": "abc-123-def",
  "status": "processing",
  "message": "Ingestion started. 45 transactions detected."
}
```

**Processing Steps:**
1. Parse CSV and validate required columns (`date`, `amount`)
2. Create a `Transaction` record for each row
3. Generate embeddings for `vendor` and `category` using MiniLM
4. Store transactions in the database
5. Run the recurrence detection algorithm
6. Generate `Forecast` records for detected recurring expenses
7. Log provenance events

### 2.2 `GET /api/dexabooks/transactions`

**Purpose:** Retrieve all transactions within a specified date range.

**Query Parameters:**
- `start_date` (optional): ISO 8601 date (e.g., `2025-10-01`)
- `end_date` (optional): ISO 8601 date (e.g., `2025-10-31`)
- `account_id` (optional): Filter by account

**Response:**
```json
{
  "transactions": [
    {
      "id": "txn-001",
      "date": "2025-10-15",
      "amount": -1200.00,
      "vendor": "Landlord Inc",
      "category": "Rent",
      "recurrence": "monthly"
    }
  ],
  "count": 1
}
```

### 2.3 `GET /api/dexabooks/forecasts`

**Purpose:** Retrieve all forecasted transactions for a future date range.

**Query Parameters:**
- `start_date` (optional): ISO 8601 date
- `end_date` (optional): ISO 8601 date

**Response:**
```json
{
  "forecasts": [
    {
      "id": "fct-001",
      "expected_date": "2025-11-15",
      "predicted_amount": -1200.00,
      "confidence": 0.95,
      "source_transaction": {
        "vendor": "Landlord Inc",
        "category": "Rent"
      }
    }
  ],
  "count": 1
}
```

### 2.4 `GET /api/dexabooks/top_expenses`

**Purpose:** Get the top N expenses by total amount spent, grouped by category or vendor.

**Query Parameters:**
- `limit` (optional): Number of results to return (default: 10)
- `group_by` (optional): `category` or `vendor` (default: `category`)

**Response:**
```json
{
  "top_expenses": [
    {
      "category": "Rent",
      "total_amount": -14400.00,
      "transaction_count": 12
    },
    {
      "category": "Utilities",
      "total_amount": -1024.56,
      "transaction_count": 12
    }
  ]
}
```

---

## 3. Forecasting Algorithm (Rule-Based MVP)

The v1.0 forecasting logic will use a simple, rule-based approach. Future versions can incorporate machine learning.

### 3.1 Recurrence Detection

After transactions are ingested, the system will scan for patterns:

```python
from datetime import datetime, timedelta
from dateutil.relativedelta import relativedelta

def detect_recurrence(transactions):
    """
    Group transactions by vendor and analyze date intervals.
    If intervals are consistent, mark as recurring.
    """
    grouped = {}
    for txn in transactions:
        vendor = txn['vendor']
        if vendor not in grouped:
            grouped[vendor] = []
        grouped[vendor].append(txn)
    
    for vendor, txns in grouped.items():
        if len(txns) < 2:
            continue
        
        # Sort by date
        txns = sorted(txns, key=lambda x: x['date'])
        
        # Calculate intervals
        intervals = []
        for i in range(1, len(txns)):
            delta = (datetime.fromisoformat(txns[i]['date']) - 
                     datetime.fromisoformat(txns[i-1]['date'])).days
            intervals.append(delta)
        
        # Check for consistency
        avg_interval = sum(intervals) / len(intervals)
        
        if 6 <= avg_interval <= 8:  # Weekly
            for txn in txns:
                update_transaction_recurrence(txn['id'], 'weekly')
        elif 28 <= avg_interval <= 32:  # Monthly
            for txn in txns:
                update_transaction_recurrence(txn['id'], 'monthly')
```

### 3.2 Forecast Generation

Once recurrence is detected, generate future forecasts:

```python
def generate_forecasts(transaction):
    """
    Create forecast records for the next 3 occurrences of a recurring transaction.
    """
    if transaction['recurrence'] == 'monthly':
        base_date = datetime.fromisoformat(transaction['date'])
        for i in range(1, 4):  # Next 3 months
            forecast_date = base_date + relativedelta(months=i)
            create_forecast(
                source_transaction_id=transaction['id'],
                expected_date=forecast_date.isoformat(),
                predicted_amount=transaction['amount'],
                confidence=0.85  # High confidence for monthly patterns
            )
    elif transaction['recurrence'] == 'weekly':
        base_date = datetime.fromisoformat(transaction['date'])
        for i in range(1, 13):  # Next 12 weeks
            forecast_date = base_date + timedelta(weeks=i)
            create_forecast(
                source_transaction_id=transaction['id'],
                expected_date=forecast_date.isoformat(),
                predicted_amount=transaction['amount'],
                confidence=0.80
            )
```

---

## 4. Frontend Component Specifications

The DexaBooks frontend will be a new, standalone SPA that reuses only the core infrastructure from LoomLite (event bus, config, basic HTML structure) and introduces completely new financial visualizations.

### 4.1 Project Structure

```
/dexabooks
â”œâ”€â”€ frontend/
â”‚   â”œâ”€â”€ index.html              (Main dashboard page)
â”‚   â”œâ”€â”€ config.js               (Backend API URL configuration)
â”‚   â”œâ”€â”€ eventBus.js             (Copied from LoomLite)
â”‚   â”œâ”€â”€ cashFlowTimeline.js     (New: D3 timeline visualization)
â”‚   â”œâ”€â”€ expenseBreakdown.js     (New: D3 bar chart)
â”‚   â”œâ”€â”€ financialNavigator.js   (Adapted from LoomLite's navigator)
â”‚   â”œâ”€â”€ transactionViewer.js    (New: Detail panel for transactions)
â”‚   â””â”€â”€ styles/
â”‚       â””â”€â”€ dexabooks.css       (Custom styling)
â””â”€â”€ README.md
```

### 4.2 Core Visualization: Cash Flow Timeline

**File:** `cashFlowTimeline.js`

**Description:** A horizontal D3.js timeline that displays all transactions (past) and forecasts (future) on a chronological axis. The current date is marked with a vertical line. Past transactions appear as solid circles, future forecasts as dashed circles with opacity based on confidence.

**Key Features:**
- X-axis: Time (date)
- Y-axis: Amount (with negative values for expenses, positive for income)
- Color coding: Categories (e.g., Rent = blue, Utilities = orange)
- Hover interaction: Shows full transaction details
- Click interaction: Emits `transactionSelected` event to the event bus

**Data Source:** Fetches from `/api/dexabooks/transactions` and `/api/dexabooks/forecasts`

### 4.3 Core Visualization: Expense Breakdown

**File:** `expenseBreakdown.js`

**Description:** A vertical D3.js bar chart showing the top 10 expense categories or vendors by total amount spent.

**Key Features:**
- X-axis: Category/Vendor name
- Y-axis: Total amount spent
- Sorted: Descending by amount
- Click interaction: Filters the timeline to show only transactions in that category

**Data Source:** Fetches from `/api/dexabooks/top_expenses`

### 4.4 Financial Navigator

**File:** `financialNavigator.js`

**Description:** A left sidebar adapted from LoomLite's `navigatorV2.js` that displays accounts and time-based filters instead of documents and folders.

**Sections:**
- **Accounts:** List of all financial accounts (checking, credit cards, etc.)
- **Time Filters:** Quick links for "Next 7 Days", "Next 30 Days", "This Month", "This Quarter"
- **Top Expenses:** A mini-list of the top 5 recurring expenses

### 4.5 Transaction Viewer

**File:** `transactionViewer.js`

**Description:** A right-side panel (similar to LoomLite's `surfaceViewer.js`) that displays detailed information about a selected transaction or forecast.

**Tabs:**
- **Details:** Date, amount, vendor, category, description
- **Provenance:** Audit trail showing when the transaction was ingested, when embeddings were generated, and forecast confidence if applicable
- **Similar:** A list of semantically similar transactions (using vector search)

---

## 5. Deployment Strategy

### 5.1 Backend Deployment (No Changes Required)

The existing LoomLite backend on Render will continue to run. The new DexaBooks module will be added to the same codebase and will automatically deploy with the next push to the repository.

### 5.2 Frontend Deployment (New Vercel Project)

A new Vercel project will be created for the DexaBooks frontend:

1. Create a new repository: `dexabooks-frontend` (or add `/dexabooks` as a subdirectory in the existing repo)
2. Connect to Vercel
3. Configure the build settings to point to the `/dexabooks/frontend` directory
4. Set the `BACKEND_URL` environment variable to point to the Render backend

**Result:** Two separate frontend URLs, one backend.

---

## 6. Success Criteria for v1.0

The MVP will be considered complete when:

1. A user can upload a CSV file of transactions via the DexaBooks UI
2. The system correctly parses the CSV and stores transactions in the database
3. The recurrence detection algorithm identifies at least one recurring expense
4. At least one forecast is generated and stored
5. The Cash Flow Timeline renders both historical and forecasted transactions
6. The Expense Breakdown chart displays the top 10 categories
7. Clicking a transaction on the timeline displays its details in the Transaction Viewer
8. The system logs provenance events for all key operations

---

**Author:** Manus AI  
**Last Updated:** October 29, 2025
